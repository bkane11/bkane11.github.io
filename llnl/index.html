<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Ben Kane - info</title>

		<meta name="description" content="A framework for easily creating beautiful presentations using HTML">
		<meta name="author" content="Ben Kane">

		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<link rel="shortcut icon" href="../favicon.ico">

		
		<link rel="stylesheet" href="./css/reveal.css">
		<link rel="stylesheet" href="./css/theme/black.css" id="theme">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="./lib/css/zenburn.css">

		
		<link rel="stylesheet" href="./css/custom.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? './css/print/pdf.css' : './css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section>
					<h1>Ben Kane</h1>
					<h3>Experience and Skills</h3>
					<p>
						<small>Created with: <a href="http://lab.hakim.se/reveal-js">Reveal.js</a></small>
					</p>
				</section>

				<!-- RESUME SECTION -->
				<section>
					<h2>Resum√©</h2>
					<section>
						<br/>
							<iframe 
							width="100%" height="590" frameborder="0" marginwidth="0" marginheight="0" scrolling="yes" style="border:none; margin-bottom:-45px; max-width: 100%;" allowfullscreen
							data-src="./images/Resume - Ben Kane.pdf"></iframe>
							<a href="./images/Resume - Ben Kane.pdf">view</a>
					</section>
				</section>

				<!-- SKILLS SECTION -->
				<section>
					<h2>Skills</h2>
					<section>
						<p>
							<br/>
							<img style="border:none; background-color: #fff; padding: 15px 10px 0px;" src="./images/skills wordcloud.svg"/>
						</p>
					</section>
					<section>
						<p>
							<a target="_blank" href="https://github.com/bkane11">github
									<svg height="45" version="1.1" viewBox="0 0 16 16" width="45" style="fill:#fff; vertical-align:middle;"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path></svg>
								</a>
						</p>
						<p class="fragment">Application development</p>
						<p class="fragment">Data management</p>
						<p class="fragment">Visualization</p>
						<p class="fragment">Geospatial analysis</p>
						<br/>
					</section>

					<!-- <section>
						<p>
							<br/>
							<img style="border:none; background-color: #fff; padding: 15px 10px 0px;" src="./images/skills wordcloud.svg"/>
						</p>
					</section> -->
					<section>
						<p>Python
							<img style="height:45px; border: none;background-color: transparent; vertical-align: middle;"
    						src="http://orlandopy.a2hosted.com/images/python-logo-glassy.png"/>
						</p>
						<p class="fragment">
							<a target="_blank" href="https://github.com/aecom-oakland-dms/poak-scripting-tools/tree/master/GIS2CAD/python_scripts">GIS<=>CAD python conversion scripts
								<svg height="45" version="1.1" viewBox="0 0 16 16" width="45" style="fill:#fff; vertical-align:middle;"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path></svg>
							</a>		
						</p>

					</section>
					<section>
						<p>Python
							<img style="height:45px; border: none;background-color: transparent; vertical-align: middle;"
    						src="http://orlandopy.a2hosted.com/images/python-logo-glassy.png"/>
    						<small style="display: block;"><a target="_blank" href="https://github.com/aecom-oakland-dms/poak-scripting-tools/tree/master/GIS2CAD/python_scripts">FCobject Class in GIS2CAD
								<svg height="45" version="1.1" viewBox="0 0 16 16" width="45" style="fill:#fff; vertical-align:middle;"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path></svg>
							</a></small>
							<pre><code style="font-size:15px;" class="hljs" data-trim >
import os
import re
import arcpy
import ntpath
import config

import mergeconfig
mergeconfig.mergeFromModule(globals(), config)

import Logger

class FCobject(object):
    NO_FEATURE_IN_SDE = False

    def __init__(self, feature, fd, logfilename, FME_MacroValues):
        # set gp environment to SDEworkspace before listing fields etc
        if arcpy.env.workspace != SDEworkspace:
            arcpy.env.workspace = SDEworkspace
        
        self.featureDataset = fd 
        self.name = feature

        if not arcpy.Exists(feature):
            print('NO_FEATURE_IN_SDE found for:', str(fd), str(feature))
            self.NO_FEATURE_IN_SDE = True
            return None

        self.outGDB = config.outGDB
        self.fields = self.getFields(workspace=SDEworkspace)
        self.desc = arcpy.Describe(feature)
        
        logroot = None
        if hasattr(config, 'logroot'):
            logroot = config.logroot

        self.setFME_MacroValues(FME_MacroValues)
        self.initiateLogger(logfilename=logfilename, logroot=logroot)

        self.log('initializing FCobject for:', feature)

        self.output = os.path.join(outGDB, self.featureDataset, feature)
        self.geometry = None
        if not arcpy.Exists(self.output):
            geomtype = self.desc.shapeType.upper().replace('MULTIPOLYGON', 'POLYGON')
            self.log(geomtype)
            self.log('creating fc output:', self.output, geomtype)
            workspace = os.path.join(outGDB, self.featureDataset)
            
            # make the destination gdb if it doesn't exist
            if not arcpy.Exists(outGDB):
                print 'creating outGDB at:', outGDB, ntpath.split(outGDB)
                arcpy.CreateFileGDB_management( *ntpath.split(outGDB) )
                
            # make the destination featureDataset if it doesn't exist
            if not arcpy.Exists(workspace):
                arcpy.CreateFeatureDataset_management(outGDB, self.featureDataset
                    , os.path.join(config.SDEworkspace, self.featureDataset) # SRS
                )

            arcpy.CreateFeatureclass_management( 
                workspace # workspace to create fc in
                , self.name # fc name
                , geomtype #geometry type
                , os.path.join(SDEworkspace, self.featureDataset, feature)  #template feature
             )

    def setFME_MacroValues(self, FME_MacroValues):
        self.FME_MacroValues = FME_MacroValues

    def initiateLogger(self, logfilename='log.csv', logroot=None):
        logger = Logger.Logger( filename=logfilename, logroot=logroot )
        self.log = logger.log
        self.logToFile = logger.logToFile

    def setWorkspace(self, workspace=None):
        if workspace:
            arcpy.env.workspace = workspace
        elif arcpy.env.workspace != self.outGDB:
            arcpy.env.workspace = self.outGDB

    def getFields(self, workspace=None):
        self.setWorkspace(workspace)
        return arcpy.ListFields(self.name, '*')

    def getField(self, fieldName, workspace=None):
        self.setWorkspace(workspace)
        return len(arcpy.ListFields(self.name, fieldName)) > 0

    def addField(self, fieldName, field_type='TEXT', field_length=None, workspace=None):
        self.setWorkspace(workspace)
        arcpy.AddField_management(self.name, fieldName, field_type=field_type, field_length=field_length)
        # update the stored fields
        self.updateOwnFields()
        return self

    def updateOwnFields(self):
        self.fields = self.getFields()
							</code></pre>
						</p>
					</section>

					<section>
						<p>Python
							<img style="height:45px; border: none;background-color: transparent; vertical-align: middle;"
    						src="http://orlandopy.a2hosted.com/images/python-logo-glassy.png"/>
							<small style="display: block;">Buffer, clip, package as kmz and spreadsheet geoprocessing service (1 - entry point)</small>
							<pre><code style="font-size:15px;" class="hljs" data-trim >
import sys
import os
# add the containing folder to the path so that modules can be imported
GIS_DIR = r'\\PATH\TO\BASE\DIRECTORY'
 
# add the containing folder to the path so that modules can be imported
sys.path.append(os.path.join(GIS_DIR, r'PATH\TO\PROJECT\00_Scripts\Geoprocessing_Services\buffer_point_cnddb_intersect'))
 
from interface_accepting_variable_input_geometries import startInterface
 
startInterface()
							</code></pre>
						</p>
					</section>
					<section>
						<p>Python
							<img style="height:45px; border: none;background-color: transparent; vertical-align: middle;"
    						src="http://orlandopy.a2hosted.com/images/python-logo-glassy.png"/>
							<small style="display: block;">Buffer, clip, package as kmz and spreadsheet geoprocessing service (2 - interface)</small>
							<pre><code style="font-size:15px;" class="hljs" data-trim >
# -*- coding: utf-8 -*-
import arcpy
import sys
import os
 
sys.path.append('..')
 
# local imports
import operation_accepting_variable_input_geometry as operation
from configuration import *
from util import *
 
 
def startInterface(*args, **kwargs):
  POINT = getShapeFromFeatureSet(0)
  polygon = getShapeFromFeatureSet(1)
 
  points_from_list = getResultsFromResultSet(2, ['Longitude', 'Latitude'])
  buffer_distance = arcpy.GetParameter(3) #if arcpy.GetParameterAsText(3) in [None, ''] else 10
  datasource_list = arcpy.GetParameter(4) #if len(arcpy.GetParameter(4))==0 in [None, ''] else None
 
  message('buffer_distance: {}'.format(buffer_distance))
  message('points_from_list: {}'.format(map(lambda x: x, filter(lambda y: isinstance(y, arcpy.Point), points_from_list))))
  message('datasource list: {0}'.format(arcpy.GetParameter(4)))
 
  return operation.runOperation(input_point=POINT,
                                polygon=polygon,
                                points_from_list=points_from_list,
                                BUFFER_DISTANCE=buffer_distance,
                                DATASOURCE_LIST=datasource_list)
 
 
if __name__ == '__main__':
  startInterface()
							</code></pre>
						</p>
					</section>
					<section>
						<p>Python
							<img style="height:45px; border: none;background-color: transparent; vertical-align: middle;"
    						src="http://orlandopy.a2hosted.com/images/python-logo-glassy.png"/>
							<small style="display: block;">Buffer, clip, package as kmz and spreadsheet geoprocessing service (3 - operation)</small>
							<pre><code style="font-size:15px;" class="hljs" data-trim >
# -*- coding: utf-8 -*-
from __future__ import print_function
 
import arcpy
import os
import sys
from collections import OrderedDict
import tempfile
 
sys.path.append('..')
 
from configuration import *
from util import *
 
def runOperation(input_point=None, polygon=None, points_from_list=None, BUFFER_DISTANCE=10, DATASOURCE_LIST=[]):
  message('running...')
 
  tempdir = getTempDir()
 
  POINT = None
  DEFAULT_LAYERS = filter(lambda item: item not in EXLUDE_FROM_DEFAULT, DATASETS.keys())
  fc_list = DEFAULT_LAYERS if len(DATASOURCE_LIST)==0 else DATASOURCE_LIST
 
  FCs = OrderedDict(map(lambda name: prepFCListItem(name, tempdir), fc_list))
 
  if input_point is not None and isinstance(input_point, arcpy.PointGeometry):
    POINT = input_point.projectAs(SPATIAL_REFERENCE)
  elif len(points_from_list)>0:
    POINT = arcpy.Multipoint(arcpy.Array(points_from_list), SPATIAL_REFERENCE)
 
  FCs['area_of_interest'] = createAreaOfInterest(tempdir=tempdir, POINT=POINT, polygon=polygon, BUFFER_DISTANCE=BUFFER_DISTANCE)
  if FCs['area_of_interest'] is None:
    return
 
  message('AREA_OF_INTEREST: {0}'.format(FCs['area_of_interest']))
 
  
  if POINT is not None:
    output = createOutputFC('input_point', tempdir)
    FCs['input_point'] = arcpy.CopyFeatures_management(POINT, output)
    addLatLngToPoint(output, explode_multipoints=True)
 
  groups = []
  if len(DATASOURCE_LIST)>0:
    groups = map(lambda item: [DATASETS[item], FCs['area_of_interest'], FCs[item], item], DATASOURCE_LIST)
  else:
    groups = map(lambda item: [DATASETS[item], FCs['area_of_interest'], FCs[item], item], DEFAULT_LAYERS)
 
  runClipProcedure(groups)
 
  FeatureLists = OrderedDict()
  for name, fc in FCs.items():
    if name in ['area_of_interest']:
      continue
    # pass the PointGeometry directly if not using the Near_analysis tool (because we can't since it's not available at Standard license level :( )
    # ONLY calculate distance to point if the input is actually a point (or points)
      # otherwise, pass the point FeatureClass
      # calculateDistanceFromInput(pointFC, fc)
    if name in ['input_point']:
      item, rows = createFeatureList(fc, explode_multipoints=True)
    elif POINT is not None:
      item, rows = createFeatureList(fc, point=POINT)
    else:
      item, rows = createFeatureList(fc)
 
    FeatureLists[name] = rows
 
  # convert the temp FeatureClasses to a FeatureSets
  FSets = convertItems(FCs)
 
  tempdir2 = tempfile.mkdtemp(dir=OUTPUT_DIR)
  # Set the output parameters
 
  if POINT is not None:
    arcpy.SetParameter(5, FSets['input_point'])
    createOutputKMZ(FSets['input_point'], 'input_point', tempdir2)
 
  createOutputKMZ(FSets['area_of_interest'], 'area_of_interest', tempdir2)
  arcpy.SetParameter(6, FSets['area_of_interest'])
 
  for index, item in enumerate(DATASETS.keys(), 7):
    if item in FSets:
      message('Setting output parameter {0} for: {1}'.format(index, item))
      arcpy.SetParameter(index, FSets[item])
      createOutputKMZ(FSets[item], item, tempdir2)
    else:
      message('skipping/not-setting empty output parameter {0} for: {1}'.format(index, item))
 
  nextItem = index + 1
 
  outputSpreadsheet = createOutputExcel(FeatureLists, dir_name=tempdir2)
  outputZip = createOutputZip(tempdir2)
  arcpy.SetParameter(nextItem, outputZip)
 
  return FSets
 
 
if __name__ == "__main__":
  # freeze_support()
  # MULTIPROCESSING = True
  # CLEANUP_AFTER = False
  runOperation(
      # input_point=arcpy.PointGeometry(arcpy.Point(-121, 38), SPATIAL_REFERENCE),
      points_from_list=[arcpy.Point(-121, 38), arcpy.Point(-121.234, 38.234)],
      BUFFER_DISTANCE=1,
      DATASOURCE_LIST=['CNDDB areas']
      # DATASOURCE_LIST=['USFWS ESJB']
    )
							</code></pre>
						</p>
					</section>
					<section>
						<p>Python
							<img style="height:45px; border: none;background-color: transparent; vertical-align: middle;"
    						src="http://orlandopy.a2hosted.com/images/python-logo-glassy.png"/>
							<small style="display: block;">Buffer, clip, package as kmz and spreadsheet geoprocessing service (4 - util)</small>
							<pre><code style="font-size:15px;" class="hljs" data-trim >
import arcpy
import uuid
import sys
import shutil
import tempfile
import os
import threading
import xlwt
import re
# from threading import Timer
# from multiprocessing import Pool, cpu_count, freeze_support
# from concurrent.futures import ThreadPoolExecutor, wait, as_completed
 
 
# add the containing folder to the path so that modules can be imported
sys.path.append('..')
 
from configuration import *
 
def getTempDir():
  return tempfile.mkdtemp(dir=OUTPUT_DIR)
 
def createUUID():
  return str(uuid.uuid4())
 
def message(*msg):
  arcpy.AddMessage(*msg)
 
def addLatLngToPoint(fc, explode_multipoints=False):
  latField = 'Latitude'
  lngField = 'Longitude'
  fieldnames = [f.name for f in arcpy.ListFields(fc)]
 
  if latField not in fieldnames:
    arcpy.AddField_management(fc, field_name=latField, field_type='DOUBLE')
  if lngField not in fieldnames:
    arcpy.AddField_management(fc, field_name=lngField, field_type='DOUBLE')
 
  addItems = []
  deleteItems = []
  fields = ['SHAPE@', latField, lngField]
  with arcpy.da.UpdateCursor(fc, fields + ['OID@']) as uc:
    for row in uc:
      shape = row[0]
      if shape.partCount > 1:
        if explode_multipoints:
          for i in range(0, shape.partCount):
            # creat a new multipoint geometry for each of the points in the primary multipoint
            # so each is in it's own row in the output fc
            newshape = arcpy.Multipoint(arcpy.Array([shape.getPart(i)]), shape.spatialReference)
            addItems.append([newshape, newshape.centroid.Y, newshape.centroid.X])
            deleteItems.append(row[3])
            # uc.deleteRow()
      else:
        centerpoint = row[0].centroid #.projectAs(SPATIAL_REFERENCE)
        row[1] = centerpoint.Y
        row[2] = centerpoint.X
        uc.updateRow(row)
 
  if len(addItems)>0:
    with arcpy.da.InsertCursor(fc, fields) as ic:
      for item in addItems:
        ic.insertRow(item)
 
  if len(deleteItems)>0:
    message(deleteItems)
    with arcpy.da.UpdateCursor(fc, ['OID@']) as dc:
      for row in dc:
        message('---> '+ str(row[0]))
        if row[0] in deleteItems:
          dc.deleteRow()
 
  return fc
 
 
 
def createOutputKMZ(datasource, name, dir_name):
  # name becomes a reference to the feature layer
  arcpy.MakeFeatureLayer_management(datasource, name)
  layerFile = getLayerFile(name)
  if name is not None:
    message('arcpy.ApplySymbologyFromLayer_management({0},{1})'.format(name, layerFile))
    arcpy.ApplySymbologyFromLayer_management(name, layerFile)
  kmz = os.path.join(dir_name, name + '.kmz')
  arcpy.LayerToKML_conversion(name, kmz, is_composite=False)
  return kmz
 
def formatValueForExcel(value, name=None):
  # message('{0} -- {1} is {2} ::: {3}'.format(name, value, type(value), isinstance(value, float)))
  # if isinstance(value, float):
  #   return str(value)
  return value
 
def createOutputExcel(rowlist, dir_name=None):
  book = xlwt.Workbook(encoding="utf-8")
  filename = os.path.join(dir_name, 'GEOBROWSER_INTERSECTS_{0}.xls'.format(createUUID()))
  for item, rows in rowlist.items():
    sheet = book.add_sheet(item)
    header = rows[0]
    for rownum, row in enumerate(rows):
      for colnum, value in enumerate(row):
        sheet.write(rownum, colnum, formatValueForExcel(value, name=header[colnum]))
  book.save(filename)
  return filename
 
def verifyFieldName(name):
  return REGEX_NO_KEEP_FIELDS.search(name)
 
# optional param `point`
#   when included, the distance of each feature to that PointGeometry will be calculated
def createFeatureList(item, point=None, explode_multipoints=False):
  message('calculating near analysis for {0}:::{1}'.format(point, item))
  # Near_analysis requires Spatial Analyst for Server (included in ArcGIS Server `Advanced`, not in `Standard` :( )
  # arcpy.Near_analysis(item, point, method="GEODESIC")
  distanceFieldName = 'DISTANCE'
  fields = [f for f in arcpy.ListFields(item) if verifyFieldName(f.name) is None]
  fieldnames = [f.name for f in fields]
  # create the list of values to write to excel file
  rows =  [(['Distance to project location (meters)'] if not explode_multipoints else []) + [f.aliasName if f.aliasName not in ['', None] else f.name for f in fields]]
 
 
  if isinstance(point, arcpy.Geometry):
    projectedPoint = point.projectAs(TEALE_ALBERS, TRANSFORMATION_WGS84_TO_NAD83)
   
    if explode_multipoints:
      addLatLngToPoint(item, explode_multipoints=True)
    else:
      arcpy.AddField_management(item, field_name=distanceFieldName, field_type='DOUBLE', field_alias="Distance to project location")
 
    # the feature classes projection was created as Teale Albers (3100) since that is the coordinate system of the input source
    with arcpy.da.UpdateCursor(item, ['SHAPE@'] + ([distanceFieldName] if not explode_multipoints else []) + fieldnames) as uc:
      for row in uc:
          if not explode_multipoints:
            row[1] = row[0].distanceTo(projectedPoint)
          uc.updateRow(row)
          rows.append(row[1:])
  else:
    with arcpy.da.SearchCursor(item, fieldnames) as uc:
      for row in uc:
          rows.append(row)
 
  return item, rows
 
 
def convertItems(items):
  FSets = dict()
  for key, item in items.iteritems():
    message('Loading {0} into FeatureSet'.format(key))
    fs = arcpy.FeatureSet()
    fs.load(item)
    FSets[key] = fs
    # NO NEED TO DELETE BECAUSE ARCGIS SERVER HANDLES THAT
    del fs
  return FSets

 
  return
 
def createOutputZip(dirname):
  zipname = os.path.join(OUTPUT_DIR, 'NISTAC PW results_{0}'.format(createUUID()))
  shutil.make_archive(zipname, 'zip', dirname)
  return zipname + '.zip'
 
def getLayerFile(name):
  if name in LAYER_FILES:
    return os.path.join(LAYER_FILE_DIR, LAYER_FILES[name])
  else:
    return None
 
def createOutputFC(name, dir_name):
  message('CREATING output feature class for: {0}'.format(name))
  fcname = name + ('.shp' if USE_SHAPEFILES else '')
  message('\t===> '+fcname)
  uniqueName = arcpy.CreateUniqueName(fcname, workspace=dir_name)
  message('\t======> '+uniqueName)
  return uniqueName
 
def prepFCListItem(name, tempdir):
  message('name: {0}, tempdir: {1}'.format(name, tempdir))
  return [name, createOutputFC(name, tempdir)]
 
def runClip(inputs):
  name = inputs.pop()
 
  message('SELECTING INTERSECTING FEATURES: {0} to: {1}'.format(name, inputs[2]))
  tempfl = 'temp_{0}'.format(inputs[0])
  if name == 'Northern Spotted Owl occurences':
    arcpy.MakeFeatureLayer_management(inputs[0], tempfl, where_clause=NSOW_QUERY)[0]
  elif name == 'CNDDB areas':
    arcpy.MakeFeatureLayer_management(inputs[0], tempfl, where_clause=CNDDB_AREA_QUERY)[0]
  else:
    arcpy.MakeFeatureLayer_management(inputs[0], tempfl)[0]
  Selection = arcpy.SelectLayerByLocation_management(tempfl, "INTERSECT", inputs[1])
  # Define output selection and fc
 
  if name not in CLIP_LAYERS:
    arcpy.CopyFeatures_management(Selection, inputs[2])
  else:
    message('CLIPPING: {0} to: {1}'.format(name, inputs[2]))
    arcpy.Clip_analysis(Selection, inputs[1], inputs[2])
  return
 
def runClipInThread(item):
  message('Setting up clipping thread for: {0}'.format(item[0]))
  thread = threading.Thread(target=runClip, args=(item,))
  # thread.start()
  return thread
 
def runClipProcedure(groups):
  ## USING single thread
  if not MULTIPROCESSING:
    map(runClip, groups)
  else:
    ### POSSIBILITIES FOR RUNNING THE CLIP OPERATION CONCURRENTLY
    # - only the pool methods using multiprocessing are somewhat effective
   
    # USING multiprocessing module
    pool = Pool(processes=MAX_PROCESSES)
    pool.map(runClip, groups)
    pool.close()
    pool.join()
 
    ## USING threading
    #3   - not working
    # threadList = map(runClipInThread, groups)
    # [thread.start() for thread in threadList]
    # [thread.join() for thread in threadList]
    # message('all threads complete')
   
    ## USING concurrent.futures
    ##   - not working
    # with ThreadPoolExecutor(len(groups)) as executor:
    #   # futures = executor.map(runClip, groups)
    #   futures = []
    #   for item in groups:
    #     message('setting up thread for: {}'.format(item))
    #     futures.append(executor.submit(runClip, item))
 
    #   message('futures: {0}'.format(futures))
    # #   # message(wait(futures))
    #   for item in as_completed(futures):
    #     message('completed item: {}'.format(item))
 
  return groups
 
def createAreaOfInterest(tempdir=None, POINT=None, polygon=None, BUFFER_DISTANCE=10):
  if POINT is not None:
    message('Buffering POINT: {0}'.format(POINT.JSON))
 
    # Process: Extract Data
    return arcpy.Buffer_analysis(POINT,
      createOutputFC('area_of_interest', tempdir),
      buffer_distance_or_field='{0} miles'.format(BUFFER_DISTANCE),
      line_side='FULL',
      line_end_type='ROUND',
      dissolve_option='LIST',
      method='GEODESIC')[0]
 
  elif polygon is not None:
    return arcpy.CopyFeatures_management(polygon.projectAs(SPATIAL_REFERENCE), createOutputFC('area_of_interest', tempdir))[0]
 
  else:
    message('NO INPUT GEOMETRY SUPPLIED')
    return
 
 
def getCoordType(coord):
  # ridiculously simple check
  # bc in CA longitude is west so always negative...
  # TODO - make more robust
  if coord < 0:
    return 'longitude'
  return 'latitude'
 
def isCoordType(coord, latOrLng):
  lngrange = COORDINATE_RANGE[latOrLng]
  return lngrang['min'] < coord , lngrang['max']
 
 
def checkCoords(coords=None):
  if len(coords) != 2:
    return None
  if getCoordType(coords[0]) == 'longitude':
    message('returning: "{0}, {1}"'.format(coords[0], coords[1]))
    return arcpy.Point(coords[0], coords[1])
  if getCoordType(coords[0]) == 'latitude':
    message('returning: "{0}, {1}"'.format(coords[1], coords[0]))
    return arcpy.Point(coords[1], coords[0])
 
  message('not returning any coordingates')
  return arcpy.AddError('Incorrect lat/lng supplied : [{0}, {1}]'.format(coord1, coord2))
  # isCoordType(coord1, 'latitude'):
 
def pointInputTextToPointArray(textParam):
  return filter(
      lambda x: x is not None, [
        checkCoords(coords=[float(part) for part in REGEX_POINT_INPUT_SPLITTER.split(item) if part not in [None, '']])
        for item in formatTextParam(textParam).split(';')
      ]
    )
 
def getShapeFromFeatureSet(parameterIndex):
  shape = None
  if arcpy.GetParameterAsText(parameterIndex) in [None, '']:
    return None
  else:
    with arcpy.da.UpdateCursor(arcpy.GetParameter(parameterIndex), ['SHAPE@']) as c:
      # get the last item in the FeatureSet
      for item in c:
        if item[0] is not None:
          message('input polygon: {0}'.format(item[0].JSON))
          shape = item[0]
          # cleanup the input FeatureSet - remove current/target item
          c.deleteRow()
  return shape
 
def formatTextParam(textParam):
  # GetParameterAsText returns a unicode string, and includes single quoted values for each item...
  # so clean it up here first befor trying to work with it
  return textParam.replace("'",'')
 
def getResultsFromResultSet(parameterIndex, fields=['Longitude', 'Latitude']):
  message('getting results set for parameter {0} ::: {1}'.format(parameterIndex, arcpy.GetParameterAsText(parameterIndex)))
  textParam = arcpy.GetParameterAsText(parameterIndex)
  if textParam is None or textParam.strip() == '':
    return []
  else:
    param = arcpy.GetParameter(parameterIndex)
    points = []
    if arcpy.Exists(param):
      points += [arcpy.Point(*list(item)) for item in arcpy.da.SearchCursor(param, fields)]
    else:
      try:
        points += pointInputTextToPointArray(textParam)
      except Exception as e:
        arcpy.AddError('ERROR: {0}, with: {1}'.format(e, textParam))
   
    return points
							</code></pre>
						</p>
					</section>
					<section>
						<p>Python
							<img style="height:45px; border: none;background-color: transparent; vertical-align: middle;"
    						src="http://orlandopy.a2hosted.com/images/python-logo-glassy.png"/>
							<small style="display: block;">Buffer, clip, package as kmz and spreadsheet geoprocessing service (5 - configuration)</small>
							<pre><code style="font-size:15px;" class="hljs" data-trim >
import arcpy
import os
from collections import OrderedDict
import re
 
MAX_PROCESSES = 4
MULTIPROCESSING = None
CLEANUP_AFTER = True
 
GIS_DIR = r'\\PATH\TO\PROJECT\DIRECTORY\GIS'
# SCRIPTPATH = os.path.realpath(__file__)
 
SCRIPTPATH = os.path.join(GIS_DIR, r'Projects\CLIENT_FloodDisaster\03_Programming\00_Python\00_Scripts\Geoprocessing_Services\buffer_point_cnddb_intersect')
 
OUTPUT_DIR = os.path.join(arcpy.env.scratchFolder)
 
if not os.path.exists(OUTPUT_DIR):
  os.mkdir(OUTPUT_DIR)
 
arcpy.AddMessage('OUTPUT_DIR set to: {0}'.format(OUTPUT_DIR))
USE_SHAPEFILES = not OUTPUT_DIR.endswith('.gdb')
 
arcpy.env.overwriteOutput = True
arcpy.env.workspace = OUTPUT_DIR
arcpy.env.parallelProcessingFactor = '0'
# arcpy.env.parallelProcessingFactor = '100%'
 
STATE_SDE = os.path.join(GIS_DIR, r'GIS_Documentation\SDE_Connections\PG_State_CA.sde')
BIO_FD = os.path.join(STATE_SDE, 'Biology')
 
NSOW_QUERY = "typeobs in ('POS', 'AC')"
CNDDB_AREA_QUERY = "fedlist in ('Threatened','Delisted','Proposed Threatened','Endangered')"
 
# store the DATASETS lookup as an ordered dictionary
DATASETS = OrderedDict([
  # ['CNDDB points', os.path.join(BIO_FD, 'cnddbpnt')],
  ['CNDDB areas', os.path.join(BIO_FD, 'cnddb')],
  # ['CNDDB areas', os.path.join(STATE_SDE, 'vw_cnddb_fedlisted')], # QUERY LAYER is not a valid input for geoprocessing tools :(
  ['Northern Spotted Owl occurences', os.path.join(BIO_FD, 'Spotted_Owl_Observations')] ,
  ['Critical Habitat lines', os.path.join(BIO_FD, 'Critical_Habitat_All_Line')],
  ['Critical Habitat areas', os.path.join(BIO_FD, 'Critical_Habitat_All_Poly')],
  ['CWHR habitat', os.path.join(BIO_FD, 'CWHR_Habitat')],
  # ['CPAD holdings', os.path.join(BIO_FD, 'CPAD_2017a_Holdings')],
  #['CPAD units', os.path.join(BIO_FD, 'CPAD_2017a_Units')],
  #['CPAD superunits', os.path.join(BIO_FD, 'CPAD_2017a_SuperUnits')],
  ['USFWS ESJB', os.path.join(BIO_FD, 'USFWS_Ecological_Services_Jurisdictions')]
])
 
EXLUDE_FROM_DEFAULT = [
  'CWHR habitat',
  'USFWS ESJB'
]
 
### CLIPPING IS SLOOOOOOOW!!!
  # so only clip the layers that you really need to!
  # CWHR habitat, for example
# List of layers to clip, not just select intersecting
CLIP_LAYERS = [
  'CNDDB areas',
  'CWHR habitat',
  'USFWS ESJB',
  'Critical Habitat areas',
  'Critical Habitat lines'
]
 
LAYER_FILE_DIR = os.path.join(SCRIPTPATH, 'Layer_Files')
LAYER_FILES = {
  'input_point' : 'InputPoint.lyr',
  'area_of_interest' : 'Buffer.lyr',
  # 'CNDDB points' :  'CNDDB Points.lyr', # not using CNDDB points for geoprocessing
  'CNDDB areas' : 'CNDDB Areas.lyr',
  'Northern Spotted Owl occurences' : 'Spotted Owl Observations.lyr',
  'Critical Habitat lines' : 'Critical Habitat Lines.lyr',
  'Critical Habitat areas' : 'Critical Habitat Areas.lyr',
  'CWHR habitat' : 'CWHR Habitat.lyr',
  # 'CPAD holdings' :
  # 'CPAD units' :
  # 'CPAD superunits' :
  # 'USFWS ESJB' : 'USFWS Ecological Services Jusisdictional Boundaries.lyr'
  'USFWS ESJB' : 'USFWS ESJB.lyr'
}
 
SPATIAL_REFERENCE = arcpy.SpatialReference(4326)
 
 
TEALE_ALBERS = arcpy.SpatialReference(3310)
 
TRANSFORMATION_WGS84_TO_NAD83 = 'WGS_1984_(ITRF00)_To_NAD_1983'
 
 
REGEX_NO_KEEP_FIELDS = re.compile('^shape$', re.IGNORECASE)
REGEX_POINT_INPUT_SPLITTER = re.compile('[,\s]+', re.IGNORECASE)
 
COORDINATE_RANGE = {
  'latitude': {
    'min': 25,
    'max': 50
  },
  'longitude': {
    'min': -125,
    'max': -110
  }
}
							</code></pre>
						</p>
					</section>

					<section>
						<p>Python
							<img style="height:45px; border: none;background-color: transparent; vertical-align: middle;"
    						src="http://orlandopy.a2hosted.com/images/python-logo-glassy.png"/>
							<small style="display: block;"><a target="_blank" href="https://github.com/aecom-oakland-dms/GIS_Toolboxes/blob/master/GIS_tools/Data_Access/ArcGIS_Server/download_mapservice_to_shapefile.py">Download AGS data to shapefile
								<svg height="45" version="1.1" viewBox="0 0 16 16" width="45" style="fill:#fff; vertical-align:middle;"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path></svg>
							</a></small>
							<pre><code style="font-size:15px;" class="hljs" data-trim >
import urllib2
import os
from subprocess import Popen, PIPE
import json
import argparse
import tempfile
# import ogr2ogr
 
#TODO
# check for  EPSG PCS/GCS code 102100
# and use -t_srs and -s_srs EPSG:3857
# since the math for these is the same
 
parser = argparse.ArgumentParser(description='Download data from a ArcGIS Server MapService')
 
 
parser.add_argument('-u', '--url', type=str, nargs='?',
                    help='MapService URL')
 
parser.add_argument('-d', '--dest', type=str, nargs='?', default=os.path.join(os.path.dirname(__file__), 'outputs'),
                    help='Destination/output directory')
 
parser.add_argument('-o', '--outname', type=str, nargs='?',
                    help='Output file name - will default to layername in service if not specified')
 
parser.add_argument('-w', '--where', type=str, nargs='?',
                    help='URL encoded where statement for query')
 
parser.add_argument('-f', '--fields', type=str, nargs='?',
                    help='comma separated list of fields to return')
 
parser.add_argument('-tsrs', '--t_srs', type=str, nargs='?',
                    help='Destination SRS (e.g. "EPSG:4326"')
 
parser.add_argument('-ssrs', '--s_srs', type=str, nargs='?',
                    help='Source SRS (e.g. "EPSG:3857", which is the same as 102100...')
 
parser.add_argument('-smm', '--skip_min_max_check', default=False, action='store_true',
                    help='Skip checking for min and max objectids')
 
args = parser.parse_args()
 
MAPSERVICE_INFO = None
 
 
def prepDirectory():
  if not os.path.exists(OUTPUT_DIR):
    os.mkdir(OUTPUT_DIR)
  if not os.path.exists(os.path.join(OUTPUT_DIR, LAYERNAME)):
    os.mkdir(os.path.join(OUTPUT_DIR, LAYERNAME))
   
 
def encodeURIComponent(component):
  return urllib2.quote(unicode(component).encode('utf-8'), safe='~()*!.\'')
 
def getJSON(url, raw=False):
  print url
  data = urllib2.urlopen(url).read()
  if raw:
    return data
  return json.loads( data )
 
 
def buildQueryURL(**kwargs):
  # set default params
  if 'where' not in kwargs:
    kwargs['where'] = "1=1"
  if 'f' not in kwargs:
    kwargs['f'] = "json"
 
  # setup query base to get all fields
  query = 'query?outFields={0}&'.format(RETURN_FIELDS)
 
  for param, val in kwargs.iteritems():
    query = query + '{0}={1}&'.format(param, val)
 
  return "{0}/{1}".format(AGS, query)
 
def getMapServiceInfo():
  global MAPSERVICE_INFO, AGS
  if not MAPSERVICE_INFO:
    MAPSERVICE_INFO = getJSON(AGS+'?f=json')
  return MAPSERVICE_INFO
 
def getMaxRecordCount():
  return getMapServiceInfo().get('maxRecordCount')
 
def getLayerName():
  return getMapServiceInfo().get('name')
 
def getOIDRange():
  MAXFIELD = 'MAX_OBJECTID'
  MINFIELD = 'MIN_OBJECTID'
  STATS_PARAMS = json.dumps([
    {
      "statisticType": "min",
      "onStatisticField": "OBJECTID", "outStatisticFieldName": MINFIELD
    },{
      "statisticType": "max",
      "onStatisticField": "OBJECTID", "outStatisticFieldName": MAXFIELD
    }
  ])
  url = buildQueryURL(outStatistics=encodeURIComponent(STATS_PARAMS))
  results = getJSON(url)
  if results.get('features'):
    result = results['features'][0]['attributes']
    return result[MINFIELD], result[MAXFIELD]
 
 
def ogr2ogr(outputFile, url):
 
  # save the json data as a tempfile first
  # to be used as input to ogr2ogr
  # to avoid curl associated errors
  data = getJSON(url, raw=True)
  with tempfile.NamedTemporaryFile(mode='w', delete=False) as tempjsonfile:
    tempjsonfile.write(data)
  tempfilename = tempjsonfile.name
  print tempfilename
    
  cmd = ['ogr2ogr', '-skipFailures', '-f', 'ESRI Shapefile', '-append', '-progress', outputFile , tempfilename]
  if globals().get('T_SRS'):
    cmd += ['-t_srs', T_SRS]
  if globals().get('S_SRS'):
    cmd += ['-s_srs', S_SRS]
 
  # print Popen('IF EXIST "{0}" (echo {0} exists) ELSE (echo does not exist!!!)'.format(tempfilename)).communicate()
 
  cmdStr = ' '.join(cmd)
  print cmdStr
  # print cmd
 
  # print os.system(cmdStr)
  # result = subprocess.check_call(cmd)
  out, err = Popen(cmd, stdout=PIPE, stderr=PIPE).communicate()
  # print out, err = Popen({0}, stdout=PIPE, stderr=PIPE).communicate()".format(cmd)
 
  print 'out', out[:500]
  print 'err', err
  # delete the temporary json file
  os.unlink(tempjsonfile.name)
 
def runConversion():
  prepDirectory()
 
 
  if SKIP_MIN_MAX_CHECK not in [None, False]:
    ogr2ogr(outputFile, buildQueryURL(where=DEFAULT_WHERE, returnGeometry='true'))
    return
 
  MAX_RECORD_COUNT = getMaxRecordCount()
  MIN, MAX = getOIDRange()
  print MAX_RECORD_COUNT, MIN, MAX
  if MAX-MIN > MAX_RECORD_COUNT:
    MAX_OID = MIN
    while MAX_OID < MAX:
      MIN_OID = int(MAX_OID) # copy the last MAX_OID to be the new MIN_OID
      MAX_OID += MAX_RECORD_COUNT
      where = ('&where=%s AND' % DEFAULT_WHERE if DEFAULT_WHERE is not None else '') + "OBJECTID>={0} AND OBJECTID<{1}".format(MIN_OID, MAX_OID)
      print where
      # continue
      url = buildQueryURL(where=encodeURIComponent(where), returnGeometry='true')
      ogr2ogr(outputFile, url)
  else:
    ogr2ogr(outputFile, buildQueryURL(returnGeometry='true'))
 
def initiate(url, dest=None, outname=None, where=None, skip_min_max_check=None, t_srs=None, s_srs=None, return_fields=None):
  print url, dest, outname, where, skip_min_max_check
  global AGS, OUTPUT_DIR, LAYERNAME, outputFile, DEFAULT_WHERE, SKIP_MIN_MAX_CHECK, T_SRS, S_SRS, RETURN_FIELDS
  AGS = url
  OUTPUT_DIR = dest
  LAYERNAME = outname if outname else getLayerName()
  outputFile = os.path.join(OUTPUT_DIR, LAYERNAME, LAYERNAME + '.shp')
  DEFAULT_WHERE = where
  RETURN_FIELDS = return_fields if return_fields else '*'
  SKIP_MIN_MAX_CHECK = skip_min_max_check
  if t_srs is not None:
    T_SRS = t_srs
  if s_srs is not None:
    S_SRS = s_srs
  runConversion()
 
if __name__ == '__main__':
  initiate(args.url, dest=args.dest, outname=args.outname,
    where=args.where, skip_min_max_check=args.skip_min_max_check,
    t_srs=args.t_srs, s_srs=args.s_srs, return_fields=args.fields)
							</code></pre>
						</p>
					</section>


					<section>
						<p>JavaScript (ECMAScript 6)
						<img style="border: none;background-color: transparent; vertical-align: middle;"
    						src="http://cdn.warer.com/media/JAVAScript-collector.png"/>
    				</p>
    			</section>
    			<section>
    				<p>
    					<p>
    						<a target="_blank" href="https://github.com/aecom-oakland-dms/map-frontend-tools/tree/map-tools-general">Map application components
									<svg height="45" version="1.1" viewBox="0 0 16 16" width="45" style="fill:#fff; vertical-align:middle;"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path></svg>
								</a>
							</p>
							<div style="height:500px; width:100%; overflow-y: scroll;">
    						<div style="height: 800px;">
    							<img style="width:800px" src="./images/map-tools-general-directory-on-github.png"/>
    						</div>
    					</div>
    				</p>
					</section>
					<section>
						<p>JavaScript
							<img style="height:45px; border: none;background-color: transparent; vertical-align: middle;"
    						src="http://cdn.warer.com/media/JAVAScript-collector.png"/>
							<small style="display: block;"><a target="_blank" href="https://github.com/aecom-oakland-dms/csat-viewer/blob/master/api/controllers/GeoController.js">Geospatial data controller from Sails.js app</br>Interfaces for data stored in MongoDB, SQL Server, PostgreSQL, and MySQL
								<svg height="45" version="1.1" viewBox="0 0 16 16" width="45" style="fill:#fff; vertical-align:middle;"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path></svg>
							</a></small>
							<pre><code style="font-size:15px;" class="hljs" data-trim >
/**
 * GeoController
 *
 * @description :: Geospatial data api controller
 * @help        :: See http://links.sailsjs.org/docs/controllers
 */

let turf = require('turf')
, buildQuery = require( '../lib/query-builder' )
, respond = require( '../lib/query-responses' )
, helpers = require( '../lib/query-extensions' )
, getModel = require( '../lib/get-model')
, cache_client = require('../lib/cache_client')
, doTransforms = helpers.doTransforms
;

function selectDistinctSQL(collection, prop, where){
  let sql =  `SELECT DISTINCT ${collection}.${prop} AS SELECTION FROM ${collection}`;
  if(where)
    sql += ' where ' + where
    .replace(/\*and\*/ig, ' and ')
    .replace(/\*not\*/ig, ' not ')
    .replace(/\*or\*/ig, ' or ')
    .replace(/(.+)(<>|<|>!=|=|\*like\*)(.+)/ig, (match,g1,g2,g3)=>
      `${g1} ${g2.replace(/\*/g, '')} "${g3}"`
    );

  return sql
}

function queryDistinct(collection, prop, where){
  let Model = getModel(collection);
  if(Model && helpers.fieldInSchema(Model, prop)){
    return new Promise((resolve, reject)=>{
      let SQL;
      
      let then = (err,data)=>{ 
        if(err){
          console.log('*ERROR getting property values', err);
          SQL && console.log('** with SQL Expression:', SQL);
        }

        if(SQL)
          return resolve(data && data.map((item)=>{ return item.SELECTION }) || [])
        return resolve(data)
      }

      if(Model.query){
        SQL = selectDistinctSQL(collection, prop, where);
        // where && console.log(SQL);
        Model.query(SQL, then)
      }else if(Model.native){
        console.log('native mongo search for', prop, 'in', collection);
        Model.native((err, collection)=>{
          if(err){
            console.log('error with Model.native', err);
            return resolve([])
          }
          // http://stackoverflow.com/questions/7419986/mongodb-distinct-where-in-same-query
          // TODO - set up query distinct with where params
          let distinct = collection.distinct(prop);
          // console.log(distinct, prop)
          then(!distinct && 'no items found by `distinct` search', distinct);

        })
      }else
        return Model.find(prop).exec(then)
    })
  }
  return Promise.resolve([])
}

function Query(req, res, next){
    return getGeoJSON(req,res,next)
}

function checkCache(cache_key){
  // console.log('searching cache with key:', cache_key);
  // return cache_client.get(cache_key, then)
  return cache_client.get(cache_key)
}

function getGeoJSON(req, res, next){
  process.env.LOG_API_REQUESTS && console.log(req.url);
  let query = buildQuery(req)
  , asTopojson = req.param('topojson')
  , asGeobuf = req.param('geobuf')
  ;

  let cache_query = _.extend({}, query);
  cache_query.collection = req.param('collection')
  if(asGeobuf)
    cache_query.geobuf = true;
  else if(asTopojson)
    cache_query.geobuf = true;

  let cache_key = JSON.stringify(cache_query);

  checkCache(cache_key).then( data => {
      // parse the data into JSON if it looks like json
      // data = typeof data == 'string' ? /\{.+\}/.test(data) && JSON.parse(data) : data;
      process.env.LOG_API_REQUESTS && console.log('sending cached data for query:', cache_query); 
      // console.log('found the following data in cache for:', cache_key, data); 
      if(data)
        return res.send(data)
        // return processAndRespond(req, res, query, data)
      return doGeoJSONQuery(req, res, query)
  })

}

function doGeoJSONQuery(req, res, query){
  let collection = req.param('collection')
  , Model = getModel(collection)
  ;

  if(Model){
    let asTopojson = req.param('topojson')
    , asGeobuf = req.param('geobuf')
    , doRespond = data=>processAndRespond(req, res, query, data)
    ;

    if(query.dates){
      console.log('searching dates', query.within ? 'within' + JSON.stringify(query.within) : '');
      return Model.queryDates( query )
        .then( doRespond )
        // .then( data=>respond.processResults.call(Model, res, data, query, {topojson:asTopojson, geobuf:asGeobuf}) )
        .catch( respond.onerror.bind(res) )
    }else if(query.within){
      console.log('searching geo within')
      return Model.within( query )
        .then( doRespond )
        // .then( data=>respond.processResults.call(Model, res, data, query, {topojson:asTopojson, geobuf:asGeobuf}) )
        .catch( respond.onerror.bind(res) )
    }else{
      let q = _.extend({}, query);
      delete q.propsonly;
      delete q.geomtype;
      delete q.allFields;

      return Model.find( q )
        .exec((err, data) =>{
          if(err)
            return respond.onerror.call(res, err)
          // console.log(JSON.stringify(q), results.length)
          return doRespond(data)
          // return respond.processResults.call(Model, res, data, query, {topojson:asTopojson, geobuf:asGeobuf})
        })
    }

  }else
    res.json( turf.featurecollection([]) )
}

function processAndRespond(req, res, query, data){
  let collection = req.param('collection')
  , Model = getModel(collection)
  , asTopojson = req.param('topojson')
  , asGeobuf = req.param('geobuf')
  ;
  return respond.processResults.call(Model, res, data, query, {topojson:asTopojson, geobuf:asGeobuf})
}

function getGeoJSONWithin(req, res, next){
  let query = req.query = req.query || {};
  query.within = req.param('within');
  return getGeoJSON(req, res, next);
}

module.exports = {
  
  // '/geo/:collection/:bbox?/:simplify?' : 'GeoController.get'
  // eg
  // http://dev.server.com/geo/json/cdsm_columns?where=ElementID=01A-01*AND*ElementNo=1*AND*Column_=C
  getGeoJSON: getGeoJSON,
  getGeoJSONWithin: getGeoJSONWithin,
  
  // '/geo/:collection/propertyvalues/:prop' : 'GeoController.getPropertyValues'
  // eg
  // http://dev.server.com/geo/cdsm_columns/propertyvalues/Column_
  getPropertyValues: (req, res, next) =>{
    let collection = req.param('collection')
    , prop = req.param('prop')
    , where = req.param('where')
    , Model = getModel(collection)
    ;

    if(Model){

      if(Model.view_from){
        // if(process.env.LOG_API_REQUESTS){
        //   console.log('\n')
        //   console.log('querying distinct records from view_from attribute:', Model.view_from)
        //   console.log('\n');
        // }

        let view_from = Model.view_from;
        if(view_from instanceof Array){

          return Promise.all(
            view_from.map(collection=>{
              // console.log('view_from:', collection);
              return new Promise((resolve, reject)=>{
                queryDistinct(collection, prop, where)
                  .then(data=>resolve(data))
              })
            })
          ).then(
            function(values){
              // console.log('received values:', values)
              res.json( values.reduce((a,b)=>a.concat(b)) )
            }
            , function(err){
                console.log('promise error:', err)
            }
          )

        }else{
          return queryDistinct(view_from, prop, where)
            .then(data=>res.json(data))
        }
      }
      return queryDistinct(collection, prop, where)
        .then(data=>res.json(data))
    }
    return res.json([])
  },
  
  // '/geo/:collection/properties' : 'GeoController.getProperties'
  // eg
  // http://dev.server.com/geo/cdsm_columns/properties
  getProperties: (req, res, next) =>{
    let collection = req.param('collection')
    , Model = getModel(collection)
    ;
    if(Model){
      let SQL = 'SHOW COLUMNS FROM ' + collection;
      return Model.query(SQL, (err,data)=>{ 
          if(err){
            console.log('*ERROR getting property names', err);
            console.log('** with SQL Expression:', SQL);
          }
          res.json(data && data.map((item)=>{ return item.Field }) || []);
        })
    }
    res.json([])
  }, 

  // '/geo/:collection/query' : 'GeoController.query'
  query: Query,
  
  // '/geo/:collection/queryone' : 'GeoController.queryone'
  queryone: (req, res, next) =>{
    req.query = req.query || {};
    req.query.limit = 1;
    return Query(req, res, next)
  } 
};
							</code></pre>
						</p>
					</section><section>
						<p>JavaScript
							<img style="height:45px; border: none;background-color: transparent; vertical-align: middle;"
    						src="http://cdn.warer.com/media/JAVAScript-collector.png"/>
							<small style="display: block;"><a target="_blank" href="https://github.com/aecom-oakland-dms/map-frontend-tools/blob/map-tools-general/feature-attachments/get-AGS-attachments.js">Get AGS attachments for feature
								<svg height="45" version="1.1" viewBox="0 0 16 16" width="45" style="fill:#fff; vertical-align:middle;"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path></svg>
							</a></small>
							<pre><code style="font-size:15px;" class="hljs" data-trim >
'use strict';

function loadAGSFeatureAttachments(feature, content, Layer){
  let properties = feature.properties || feature.feature && feature.feature.properties || {}
  , loadingClass = app.config.loadingClass
  , container = $(`&lt;p class="${loadingClass} text-center">`).appendTo(content)
  , OID = typeof properties.OBJECTID !== 'undefined' ? properties.OBJECTID : properties.objectid 
  , layerId = properties.layerId
  , attachmentBase = `${Layer.options.url}/${layerId}/${OID}/attachments/`
  , url = Layer.formatQueryURL(`${attachmentBase}?f=pjson`)
  ;

  return new Promise((resolve, reject)=>{
    $.getJSON( url )
      .then(res=>{
        if(res.attachmentInfos){
          if(res.attachmentInfos.length==0)
            container.removeClass(loadingClass)

          for(let result of res.attachmentInfos){
            if(/image/i.test(result.contentType)){
              let ID;
              for(let prop of ['id', 'ID'])
                if(typeof result[prop] !== 'undefined')
                  ID = result[prop]
              let src = Layer.formatQueryURL(attachmentBase + ID);
              $('<img class="popup-image"/>')
                .on('click', evt=>modal( `<img class="img-responsive fullWidth" src="${src}"/>`) )
                .on('load', evt=>container.removeClass(loadingClass))
                .on('error', function(evt){
                  container.removeClass(loadingClass)
                  $(this).remove()
                })
                .attr('src', src)
                .appendTo(container.addClass(loadingClass))
            }
          }
        }else
          container.removeClass(loadingClass);

        resolve(res.attachmentInfos)
      })
      .fail(err=>{
        console.warn(Layer.options.name, 'get AGS attachments error:', err);
        container.removeClass(loadingClass);
        resolve()
      })
    })
}
							</code></pre>
						</p>
					</section>
					<section>
						<p>SQL
							<img style="height:140px; border: none;background-color: #fff;border-radius: 25%; vertical-align: middle;"
    						src="http://tsqlhint.com/wp-content/uploads/2017/05/query-statistic.png"/>
						</p>
					</section>
					<section>
						<p>SQL
							<img style="height:45px; border: none;background-color: #fff;border-radius: 25%; vertical-align: middle;"
    						src="http://tsqlhint.com/wp-content/uploads/2017/05/query-statistic.png"/>
							<small style="display: block;">Create mailing group, mailing items and contacts for suspect parcel mailing</small>
							<pre><code style="font-size:15px;" class="hljs" data-trim >
/*
CREATES new record in Mailing, and
CREATES new record(s) in MailingItem, and
RETURNS Mailing.ID, Mailing.GroupID, MailingItem.CorrespondenceCode
*/
 
drop procedure GEARSbusiness.sp_GenerateMailing;
go
 
create procedure GEARSbusiness.sp_GenerateMailing
(
  @MailManagementTypeID int = 1, -- 'General Correspondence'
  @UserID int = 0, -- 'blah'
  @MailingGroupID int,
  @MailingClassTypeID int = 1 -- 'Suspect Parcel mailing'
  -- @CommentID int  --- for now we'll leave the comment logic out of this procedure...
)
AS
BEGIN
  SET NOCOUNT ON;
 
  DECLARE @GeneratedMailingID int;
  DECLARE @UID int;
  DECLARE @MGID int;
  DECLARE @MGSequenceNumber int;
  DECLARE @MMTypeID int;
  DECLARE @MCTypeID int; 
  DECLARE @CorrespondenceCode nvarchar(13);
  -- DECLARE @CID int;
  DECLARE @allContacts TABLE (ID int, MailingGroupID int, APN nvarchar(50));
 
  select @UID = UserID from GEARSauth.ApplicationUser where @UserID is not null and UserID = @UserID;
  select @MGID = ID from GEARSbusiness.MailingGroup where @MailingGroupID is not null and ID = @MailingGroupID;
  select @MMTypeID = ID from GEARSbusiness.vv_MailManagementType where @MailManagementTypeID is not null and ID = @MailManagementTypeID;
  select @MCTypeID = ID from GEARSbusiness.vv_MailingClassType where @MailingClassTypeID is not null and ID = @MailingClassTypeID;
  -- select @CID = ID from GEARSbusiness.Comment where @CommentID is not null and ID = @CommentID;
 
  -- TODO - ensure User is supplied and @UID is valid
  -- TODO - ensure MailingClassTypeID is supplied @MCTypeID and is valid
  -- TODO - ensure MailManagementTypeID is supplied @MMTypeID and is valid
 
  -- if not part of an existing mail group, create a new MailGroup record
  if @MGID is Null
    BEGIN
      INSERT INTO GEARSbusiness.MailingGroup(UserID)
        VALUES(@UID);
      select @MGID=SCOPE_IDENTITY();
    END
 
  select @MGSequenceNumber = count(ID) from GEARSbusiness.Mailing where MailingGroupID = @MGID;
  IF @MGSequenceNumber is NULL
    select @MGSequenceNumber=0;
 
  select @MGSequenceNumber = GEARSbusiness.fn_MailingGroupSequenceNumber(@MGID)
 
  INSERT INTO GEARSbusiness.Mailing(MailManagementTypeID, StaffUserID, MailingGroupID, MailingGroupSequenceNo)
    VALUES(@MMTypeID, @UID, @MGID, @MGSequenceNumber);
 
  SELECT @GeneratedMailingID=SCOPE_IDENTITY();
 
  SELECT @CorrespondenceCode=GEARSbusiness.fn_CorrespondenceCode(@MGID, @MMTypeID);
 
 
  IF @MCTypeID = 1 -- Suspect Parcel Mailing, create new MailingItem record for all Parcels in SuspectParcel table
    BEGIN
     
      BEGIN TRANSACTION
     --INSERT INTO GEARSbusiness.MailingItem(MailingID, CorrespondenceCode, RecipientContactID, SuspectParcelID)
      DECLARE @SearchCursor CURSOR;
      DECLARE @MID int;
      DECLARE @CCD nvarchar(13);
      DECLARE @AgentContactID int;
      DECLARE @SuspectParcelID int;
      DECLARE @tmpContacts TABLE (ID int);
      DECLARE @tmpMailingItems TABLE (ID int);
 
      SET @SearchCursor = CURSOR FOR
        select @GeneratedMailingID, @CorrespondenceCode, AgentContactID, SuspectParcelID from GEARSbusiness.vw_SuspectParcel
 
        OPEN @SearchCursor
        while 1 = 1
        BEGIN
            FETCH NEXT FROM @SearchCursor into @MID, @CCD, @AgentContactID, @SuspectParcelID
            IF @@fetch_status <> 0
              BEGIN
                BREAK
              END
            IF COALESCE(@AgentContactID, Null) is Null
              BEGIN
                DECLARE @MGContactEntry int;
                DECLARE @fullName nvarchar(50);
                DECLARE @careOf nvarchar(50);
                DECLARE @fullStreetAddress nvarchar(255);
                DECLARE @city nvarchar(50);
                DECLARE @state nvarchar(50);
                DECLARE @zip nvarchar(50);
                DECLARE @apn nvarchar(50);
                DECLARE @contactTypeID int = 3; ---- 'Suspect Contact - Generated from LandVision parcel Assessee info
                -- just get the first one, SWRCB approved using the first contact in the instance of duplicate contacts for an parcel/APN
                Select top 1 @fullName = ASSESSEE_OWNER_NAME_1
                  , @careOf = ASMT_MAIL_CARE_OF_NAME
                  , @fullStreetAddress = ASSESSEE_MAIL_ADDR
                  , @city = ASSESSEE_MAIL_CITY
                  , @state = ASSESSEE_MAIL_STATE
                  , @zip = ASSESSEE_MAIL_ZIP
                  , @apn = PARCELAPN
                  FROM GEARSbusiness.SuspectParcel sp
                    inner join GEARSbusiness.Parcels p
                      on p.PARCELAPN = sp.APN
                      and sp.ID = @SuspectParcelID
                ;
                -- insert into temp table so the sp results don't bubble all the way out to the initial caller
                INSERT INTO @tmpContacts(ID)
                EXEC GEARSbusiness.sp_CreateContact
                  @FullName = @fullName,
                  @CareOf = @careOf,
                  @FullStreetAddress = @fullStreetAddress,
                  @City = @city,
                  @State = @state,
                  @Zip = @zip
                ;
                -- get the record
                select top 1 @AgentContactID=ID from @tmpContacts;
 
 
                -- clear the tmp table
                DELETE FROM @tmpContacts;
              END
 
            if @AgentContactID is not Null
              BEGIN
                INSERT INTO @allContacts(ID, MailingGroupID, APN) VALUES (@AgentContactID, @MGID, @apn)
              END
 
            INSERT INTO @tmpMailingItems(ID)
            EXEC GEARSbusiness.sp_CreateMailingItem
              @MailingID = @GeneratedMailingID,
              @CorrespondenceCode = @CorrespondenceCode,
              @RecipientContactID = @AgentContactID,
              @SuspectParcelID = @SuspectParcelID,
              @UserID = @UID
 
 
            select @AgentContactID=Null
        END
      CLOSE @SearchCursor
      DEALLOCATE @SearchCursor
      COMMIT TRANSACTION
 
    END
  ELSE IF @MCTypeID = 2 -- Parcel Compliance Mailing, create new MailingItem for all Parcels in ParcelCompliance table
    BEGIN
      -- TODO CREATE PARCEL COMPLIANCE METHOD(S)
      select 'Parcel Compliance' as MCTypeID
    END
  -- ELSE -- TODO
 
  -- poplate x_MailingGroup_Contact with any records that need to be generated through this procedure
  BEGIN TRANSACTION
 
  INSERT INTO GEARSbusiness.x_MailingGroup_Contact(ContactID, MailingGroupID, APN)
  select ac.ID, ac.MailingGroupID, ac.APN
  from @allContacts ac
   left outer join GEARSbusiness.x_MailingGroup_Contact xmc
   on ac.ID = xmc.ContactID and ac.MailingGroupID = xmc.MailingGroupID
   where xmc.ContactID is Null and xmc.MailingGroupID is null and xmc.APN is null
   and ac.MailingGroupID is not NULL and ac.ID is not null and ac.APN is not null
   group by ID, ac.MailingGroupID, ac.APN
  COMMIT TRANSACTION
 
  -- RETURN the Mailing.ID generated by this procedure call
  SELECT @GeneratedMailingID as MailingID, @MGID as MailingGroupID, @CorrespondenceCode as CorrespondenceCode
 
END
GO
							</code></pre>
						</p>
					</section><section>
						<p>
							<p style="margin-top:40px; padding-bottom:0;">SQL
								<img style="height:45px; border: none;background-color: #fff;border-radius: 25%; vertical-align: middle;"
    						src="http://tsqlhint.com/wp-content/uploads/2017/05/query-statistic.png"/>
							</p>
							<small style="margin-top:-25px; display: block;">User Defined Function to create a spatial view (Query Layer) from versioned feature classes
								<br/>Clips CNDDB features to polygon area from buffer in input spatial view
								<br/>Orders features in descending order by polygon area so smaller features <em style="color:orange">always</em> draw on top of larger features</small>
							<pre><code style="font-size:15px;" class="hljs" data-trim >
create or replace function create_query_layer(tablename varchar, output_view_name varchar, scm varchar default 'sde')
returns varchar AS $$
    declare search_view varchar := sde.version_view_name(scm, tablename);
    declare pw_fields varchar := get_columnnames_minus_shape(search_view);
    declare cnddb_view varchar := sde.version_view_name(scm, 'cnddb');
    declare cnddb_fields varchar := get_columnnames_minus_shape(cnddb_view); 
    declare orderby varchar := 'order by evw.description asc, sde.st_area(cnddb.shape) desc'; -- you could use this order by clause to always draw smaller shapes on top
    --declare orderby varchar := ''; -- faster than no order by, but no draw order
    declare qry varchar := format('select cast(row_number() over(%s) as integer) as objectid, evw.objectid as fid, cnddb.objectid as cnddbfid, %s, %s, sde.st_intersection(evw.shape, cnddb.shape) as shape from %s evw join %s cnddb on sde.st_intersects(evw.shape, cnddb.shape)',
      orderby,
      pw_fields,
      cnddb_fields,
      search_view,
      cnddb_view
    );
    declare command varchar := format('create view sde.%s as %s',
      output_view_name, -- function will create view with this name
      qry
    );
    --declare qry varchar := format('CREATE TEMP TABLE t_temp AS %s', command);  -- get the name of the view
begin

    execute format('drop view if exists %s', output_view_name); -- drop the temporary table
    execute command;
    return qry; -- output query used to create view
end;
$$ language plpgsql;
							</code></pre>
						</p>
					</section>
				</section>

				<section>
					<h2>Examples</h2>
					<section>
						<p><small>Web map dashboard framework - multiple clients (1 - overview)</small>
							<img style="max-height:350px;" src="./images/wch-with-toc.png"/>
							<small>Integrates near-real time field data with time-sensitive reporting data sharing, reporting, and desktop GIS.  Configurable layer and attribute access by user/role, facilitating more targeting sharing with collaborators while maintaining security of sensitive information not suitable for all team members.
							</small>
						</p>
					</section>
					<section>
						<p><small>Web map dashboard framework - multiple clients (1 - feature details)</small>
							<img style="max-height:350px;" src="./images/wch-with-feature-details.png"/>
							<small>Integrates near-real time field data with time-sensitive reporting data sharing, reporting, and desktop GIS.  Configurable layer and attribute access by user/role, facilitating more targeting sharing with collaborators while maintaining security of sensitive information not suitable for all team members.
							</small>
						</p>
					</section>
					<section>
						<p><small>Web map dashboard framework - multiple clients (2 - overview)</small>
							<img style="max-height:350px;" src="./images/emc-with-toc.png"/>
							<small>Integrates near-real time field data with time-sensitive reporting data sharing, reporting, and desktop GIS.  Configurable layer and attribute access by user/role, facilitating more targeting sharing with collaborators while maintaining security of sensitive information not suitable for all team members.
							</small>
						</p>
					</section>
					<section>
						<p>
							<a target="_blank" href="https://dwr-perris.com/#21/33.84474/-117.18698/imagery/0/0/?layers=Instrumentation%20Locations%2CCDSM%20Elements%2CStationing%2CCross%20Sections%2CCDSM%20Cells&layerconfigs=Instrumentation%20Locations%24hiddenlayers%40piezometer-filter%24opacity%40%24labels%401%2CCDSM%20Elements%24opacity%400.45%24labels%401%2CStationing%24opacity%40%24labels%401%2CCross%20Sections%24opacity%40%24labels%401%2CCDSM%20Cells%24opacity%40%24labels%401&corners=-117.18745596706867,33.84454402203937,-117.18651250004771,33.84493220020751">DWR Perris Dam Dashboard</a>
							<br/>
							<img style="max-height:350px;" src="./images/dwr-perris.png"/>
							<br/>
							<small>Dashboard for access to contruction and monitoring data for dam renovation project.  Integrated with SharePoint site used for document management and additional reporting. 
							</small>
						</p>
					</section>
					<section>
						<p>
							<a target="_blank" href="http://toxictrends.org/">Toxic Trends</a>
							<br/>
							<img style="max-height:350px;" src="./images/toxictrends.png"/>
							<br/>
							<small>Combines data from the EPA‚Äôs <a href="http://www2.epa.gov/toxics-release-inventory-tri-program">Toxics Release Inventory</a> and the <a href="http://www.epa.gov/opptintr/rsei/">Risk Screening Environmental Indicators (RSEI)</a> program to display air pollution levels.
							</small>
						</p>
					</section>
					<section>
						<p>
							<a target="_blank" href="http://bkane11.github.io/enview">Web map cartography tests</a>
							<div style="height:400">
								<iframe style="height:400px;float:left; width:47%" src="http://bkane11.github.io/enview/v1/"></iframe>
								<iframe style="height:400px;float:right; width:47%" src="http://bkane11.github.io/enview/v2/"></iframe>
								<!-- <img style="height:400px;float:left; width:47%" src="./images/enview-test-version-1.png"/> -->
								<!-- <img style="height:400px;float:right; width:47%" src="./images/enview-test-version-2.png"/> -->
							</div>
							<br/>
							<small>Explore different approaches to symbology for overlapping buffers in the browser using HTML5 canvas manipulation
							</small>
						</p>
					</section>
					
				</section>
				<section>
					<h2>Other...</h2>
					<div class="fragment" style="width:100%;height: 140px; border-top:1px #fff solid">
						<div style="font-size:30px;width:30%;margin:0 1.5%;height:100%;float:left">esri<br/>Product Administration</div>
						<div style="width:120px;margin:0 1.5%;height:100%;float:left"><img style="border-radius:15px;height:55px;background-color:#fff;" src="http://photos.prnewswire.com/prnvar/20110425/LA88950LOGO?max=100"/></div>
						<div style="width:110px;margin:0 1.5%;height:100%;float:left"><small style="margin-top: 25%;">ArcGIS Desktop</small></div>
						<div style="width:110px;margin:0 1.5%;height:100%;float:left"><small style="margin-top: 25%;">ArcGIS Enterprise (Server)</small></div>
						<div style="width:110px;margin:0 1.5%;height:100%;float:left"><small style="margin-top: 25%;">Portal for ArcGIS</small></div>
					</div>

					<div class="fragment" style="width:100%;height: 110px;border-top:1px #fff solid;">
						<div style="font-size:30px;width:30%;margin:0 1.5%;height:100%;float:left">Web<br/>Hosting</div>
						<div style="width:55px;margin:0 1.5%;height:100%;float:left"><img style="border-radius:15px;height:55px;width:55px;background-color:#fff;" src="http://1000gram.com/wp-content/uploads/2010/10/amazon-icon.png"/></div>
						<div style="width:55px;margin:0 1.5%;height:100%;float:left"><img style="border-radius:15px;height:55px;width:55px;background-color:#fff;" src="http://www.clintonfitch.com/wp-content/uploads/2017/03/Google-Cloud-Platform-Icon.png"/></div>
						<div style="margin:0 1.5%;height:100%;float:left"><img style="border-radius:15px;height:55px;background-color:#fff;" src="https://cotton-software.com/wp-content/uploads/2013/07/logo_iis75.png"/></div>
					</div>

					<div class="fragment" style="width:100%;height: 110px; border-top:1px #fff solid;">
						<div style="font-size:30px;width:30%;margin:0 1.5%;height:100%;float:left">Domain administration</div>
						<div style="margin:0 1.5%;height:100%;float:left"><img style="border-radius:15px;height:55px;background-color:#fff;" src="https://blogcdn1.secureserver.net/garage/wp-content/uploads/2015/10/GoDaddyLogo_Horizontal_Green.jpg"/></div>
					</div>

					<div class="fragment" style="width:100%;height: 110px; border-top:1px #fff solid;">
						<div style="font-size:30px;width:30%;margin:0 1.5%;height:100%;float:left">Database administration</div>
						<div style="width:55px;margin:0 1.5%;height:100%;float:left"><img style="border-radius:15px;height:55px;width:55px;background-color:#fff;" src="https://upload.wikimedia.org/wikipedia/commons/2/2e/Pg_logo.png"/></div>
						<div style="width:55px;margin:0 1.5%;height:100%;float:left"><img style="border-radius:15px;height:55px;width:55px;background-color:#fff;" src="https://www.aspwebhosting.com/images/SQLServer-logo.png"/></div>
						<div style="width:55px;margin:0 1.5%;height:100%;float:left"><img style="border-radius:15px;height:55px;width:55px;background-color:#fff;" src="https://www.clouda.ca/wp-content/uploads/2013/03/mongodb-logo.png"/></div>
						<div style="width:55px;margin:0 1.5%;height:100%;float:left"><img style="border-radius:15px;height:55px;width:55px;background-color:#fff;" src="https://www.mysql.com/common/logos/logo-mysql-170x115.png"/></div>
						<div style="width:55px;margin:0 1.5%;height:100%;float:left"><img style="border-radius:15px;height:55px;width:55px;background-color:#fff;" src="https://www.shareicon.net/data/256x256/2015/08/21/88383_logo_512x512.png"/></div>
					</div>

					<div class="fragment" style="width:100%;height: 110px; border-top:1px #fff solid;">
						<div style="font-size:30px;width:30%;margin:0 1.5%;height:100%;float:left">Version control and issue tracking</div>
						<div style="margin:0 1.5%;height:100%;float:left">
							<svg height="55" version="1.1" viewBox="0 0 16 16" width="55" style="margin-top: 25%;fill:#fff; vertical-align:middle;"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path></svg>
							</div>
					</div>
					
				</section>


	<!-- 			<section>
					<h2>Resum√©</h2>


				</section> -->

				<!-- Example of nested vertical slides -->
				<!-- <section>
					<section>
						<h2>Vertical Slides</h2>
						<p>Slides can be nested inside of each other.</p>
						<p>Use the <em>Space</em> key to navigate through all slides.</p>
						<br>
						<a href="#" class="navigate-down">
							<img width="178" height="238" data-src="https://s3.amazonaws.com/hakim-static/reveal-js/arrow.png" alt="Down arrow">
						</a>
					</section>
					<section>
						<h2>Basement Level 1</h2>
						<p>Nested slides are useful for adding additional detail underneath a high level horizontal slide.</p>
					</section>
					<section>
						<h2>Basement Level 2</h2>
						<p>That's it, time to go back up.</p>
						<br>
						<a href="#/2">
							<img width="178" height="238" data-src="https://s3.amazonaws.com/hakim-static/reveal-js/arrow.png" alt="Up arrow" style="transform: rotate(180deg); -webkit-transform: rotate(180deg);">
						</a>
					</section>
				</section>

				<section>
					<h2>Slides</h2>
					<p>
						Not a coder? Not a problem. There's a fully-featured visual editor for authoring these, try it out at <a href="http://slides.com" target="_blank">http://slides.com</a>.
					</p>
				</section>

				<section>
					<h2>Point of View</h2>
					<p>
						Press <strong>ESC</strong> to enter the slide overview.
					</p>
					<p>
						Hold down alt and click on any element to zoom in on it using <a href="http://lab.hakim.se/zoom-js">zoom.js</a>. Alt + click anywhere to zoom back out.
					</p>
				</section>

				<section>
					<h2>Touch Optimized</h2>
					<p>
						Presentations look great on touch devices, like mobile phones and tablets. Simply swipe through your slides.
					</p>
				</section>

				<section data-markdown>
					<script type="text/template">
						## Markdown support

						Write content using inline or external Markdown.
						Instructions and more info available in the [readme](https://github.com/hakimel/reveal.js#markdown).

						```
						<section data-markdown>
						  ## Markdown support

						  Write content using inline or external Markdown.
						  Instructions and more info available in the [readme](https://github.com/hakimel/reveal.js#markdown).
						</section>
						```
					</script>
				</section>

				<section>
					<section id="fragments">
						<h2>Fragments</h2>
						<p>Hit the next arrow...</p>
						<p class="fragment">... to step through ...</p>
						<p><span class="fragment">... a</span> <span class="fragment">fragmented</span> <span class="fragment">slide.</span></p>

						<aside class="notes">
							This slide has fragments which are also stepped through in the notes window.
						</aside>
					</section>
					<section>
						<h2>Fragment Styles</h2>
						<p>There's different types of fragments, like:</p>
						<p class="fragment grow">grow</p>
						<p class="fragment shrink">shrink</p>
						<p class="fragment fade-out">fade-out</p>
						<p class="fragment fade-up">fade-up (also down, left and right!)</p>
						<p class="fragment current-visible">current-visible</p>
						<p>Highlight <span class="fragment highlight-red">red</span> <span class="fragment highlight-blue">blue</span> <span class="fragment highlight-green">green</span></p>
					</section>
				</section>

				<section id="transitions">
					<h2>Transition Styles</h2>
					<p>
						You can select from different transitions, like: <br>
						<a href="?transition=none#/transitions">None</a> -
						<a href="?transition=fade#/transitions">Fade</a> -
						<a href="?transition=slide#/transitions">Slide</a> -
						<a href="?transition=convex#/transitions">Convex</a> -
						<a href="?transition=concave#/transitions">Concave</a> -
						<a href="?transition=zoom#/transitions">Zoom</a>
					</p>
				</section>
				<section>
					<section data-background="#dddddd">
						<h2>Slide Backgrounds</h2>
						<p>
							Set <code>data-background="#dddddd"</code> on a slide to change the background color. All CSS color formats are supported.
						</p>
						<a href="#" class="navigate-down">
							<img width="178" height="238" data-src="https://s3.amazonaws.com/hakim-static/reveal-js/arrow.png" alt="Down arrow">
						</a>
					</section>
					<section data-background="https://s3.amazonaws.com/hakim-static/reveal-js/image-placeholder.png">
						<h2>Image Backgrounds</h2>
						<pre><code style="font-size:15px;" class="hljs">&lt;section data-background="image.png"&gt;</code></pre>
					</section>
					<section data-background="https://s3.amazonaws.com/hakim-static/reveal-js/image-placeholder.png" data-background-repeat="repeat" data-background-size="100px">
						<h2>Tiled Backgrounds</h2>
						<pre><code style="font-size:15px;" class="hljs" style="word-wrap: break-word;">&lt;section data-background="image.png" data-background-repeat="repeat" data-background-size="100px"&gt;</code></pre>
					</section>
					<section data-background-video="https://s3.amazonaws.com/static.slid.es/site/homepage/v1/homepage-video-editor.mp4,https://s3.amazonaws.com/static.slid.es/site/homepage/v1/homepage-video-editor.webm" data-background-color="#000000">
						<div style="background-color: rgba(0, 0, 0, 0.9); color: #fff; padding: 20px;">
							<h2>Video Backgrounds</h2>
							<pre><code style="font-size:15px;" class="hljs" style="word-wrap: break-word;">&lt;section data-background-video="video.mp4,video.webm"&gt;</code></pre>
						</div>
					</section>
					<section data-background="http://i.giphy.com/90F8aUepslB84.gif">
						<h2>... and GIFs!</h2>
					</section>
				</section>

				<section data-transition="slide" data-background="#4d7e65" data-background-transition="zoom">
					<h2>Background Transitions</h2>
					<p>
						Different background transitions are available via the backgroundTransition option. This one's called "zoom".
					</p>
					<pre><code style="font-size:15px;" class="hljs">Reveal.configure({ backgroundTransition: 'zoom' })</code></pre>
				</section>

				<section data-transition="slide" data-background="#b5533c" data-background-transition="zoom">
					<h2>Background Transitions</h2>
					<p>
						You can override background transitions per-slide.
					</p>
					<pre><code style="font-size:15px;" class="hljs" style="word-wrap: break-word;">&lt;section data-background-transition="zoom"&gt;</code></pre>
				</section>

				<section>
					<h2>Pretty Code</h2>
					<pre><code style="font-size:15px;" class="hljs" data-trim >
function linkify( selector ) {
  if( supports3DTransforms ) {

    var nodes = document.querySelectorAll( selector );

    for( var i = 0, len = nodes.length; i &lt; len; i++ ) {
      var node = nodes[i];

      if( !node.className ) {
        node.className += ' roll';
      }
    }
  }
}
					</code></pre>
					<p>Code syntax highlighting courtesy of <a href="http://softwaremaniacs.org/soft/highlight/en/description/">highlight.js</a>.</p>
				</section>

				<section>
					<h2>Marvelous List</h2>
					<ul>
						<li>No order here</li>
						<li>Or here</li>
						<li>Or here</li>
						<li>Or here</li>
					</ul>
				</section>

				<section>
					<h2>Fantastic Ordered List</h2>
					<ol>
						<li>One is smaller than...</li>
						<li>Two is smaller than...</li>
						<li>Three!</li>
					</ol>
				</section>

				<section>
					<h2>Tabular Tables</h2>
					<table>
						<thead>
							<tr>
								<th>Item</th>
								<th>Value</th>
								<th>Quantity</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td>Apples</td>
								<td>$1</td>
								<td>7</td>
							</tr>
							<tr>
								<td>Lemonade</td>
								<td>$2</td>
								<td>18</td>
							</tr>
							<tr>
								<td>Bread</td>
								<td>$3</td>
								<td>2</td>
							</tr>
						</tbody>
					</table>
				</section>

				<section>
					<h2>Clever Quotes</h2>
					<p>
						These guys come in two forms, inline: <q cite="http://searchservervirtualization.techtarget.com/definition/Our-Favorite-Technology-Quotations">
						&ldquo;The nice thing about standards is that there are so many to choose from&rdquo;</q> and block:
					</p>
					<blockquote cite="http://searchservervirtualization.techtarget.com/definition/Our-Favorite-Technology-Quotations">
						&ldquo;For years there has been a theory that millions of monkeys typing at random on millions of typewriters would
						reproduce the entire works of Shakespeare. The Internet has proven this theory to be untrue.&rdquo;
					</blockquote>
				</section>

				<section>
					<h2>Intergalactic Interconnections</h2>
					<p>
						You can link between slides internally,
						<a href="#/2/3">like this</a>.
					</p>
				</section>

				<section>
					<h2>Speaker View</h2>
					<p>There's a <a href="https://github.com/hakimel/reveal.js#speaker-notes">speaker view</a>. It includes a timer, preview of the upcoming slide as well as your speaker notes.</p>
					<p>Press the <em>S</em> key to try it out.</p>

					<aside class="notes">
						Oh hey, these are some notes. They'll be hidden in your presentation, but you can see them if you open the speaker notes window (hit 's' on your keyboard).
					</aside>
				</section>

				<section>
					<h2>Export to PDF</h2>
					<p>Presentations can be <a href="https://github.com/hakimel/reveal.js#pdf-export">exported to PDF</a>, here's an example:</p>
					<iframe data-src="https://www.slideshare.net/slideshow/embed_code/42840540" width="445" height="355" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:3px solid #666; margin-bottom:5px; max-width: 100%;" allowfullscreen> </iframe>
				</section>

				<section>
					<h2>Global State</h2>
					<p>
						Set <code>data-state="something"</code> on a slide and <code>"something"</code>
						will be added as a class to the document element when the slide is open. This lets you
						apply broader style changes, like switching the page background.
					</p>
				</section>

				<section data-state="customevent">
					<h2>State Events</h2>
					<p>
						Additionally custom events can be triggered on a per slide basis by binding to the <code>data-state</code> name.
					</p>
					<pre><code style="font-size:15px;" class="javascript" data-trim  style="font-size: 18px;">
Reveal.addEventListener( 'customevent', function() {
	console.log( '"customevent" has fired' );
} );
					</code></pre>
				</section>

				<section>
					<h2>Take a Moment</h2>
					<p>
						Press B or . on your keyboard to pause the presentation. This is helpful when you're on stage and want to take distracting slides off the screen.
					</p>
				</section>

				<section>
					<h2>Much more</h2>
					<ul>
						<li>Right-to-left support</li>
						<li><a href="https://github.com/hakimel/reveal.js#api">Extensive JavaScript API</a></li>
						<li><a href="https://github.com/hakimel/reveal.js#auto-sliding">Auto-progression</a></li>
						<li><a href="https://github.com/hakimel/reveal.js#parallax-background">Parallax backgrounds</a></li>
						<li><a href="https://github.com/hakimel/reveal.js#keyboard-bindings">Custom keyboard bindings</a></li>
					</ul>
				</section> -->

				<section>
					<h1>Thank you!</h1>
					<p>
						<a href="mailto:benkane11@gmail.com">benkane11@gmail.com</a> <br>
					</p>
				</section>

			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>

			// More info https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// More info https://github.com/hakimel/reveal.js#dependencies
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});

		</script>

	</body>
</html>
