function initialize(){var a={zoom:6,center:new google.maps.LatLng(60,105)};geocoder=new google.maps.Geocoder,map=new google.maps.Map(document.getElementById("map-canvas"),a),locate("init"),geocodeStores(),autocomplete=new google.maps.places.Autocomplete($("input.location")[0]),autocomplete.bindTo("bounds",map),google.maps.event.addListener(autocomplete,"place_changed",onPlaceChanged),distanceMatrix=new google.maps.DistanceMatrixService,directionsService=new google.maps.DirectionsService}function getDrivingDistance(a,b,c){showLoading(),hideLayers(directionsLayers),directionsLayers=[],b=stores.map(function(a){return $(a.info)[1].innerText}),distanceMatrix.getDistanceMatrix({origins:[a],destinations:b instanceof Array?b:[b],travelMode:google.maps.TravelMode.DRIVING,unitSystem:google.maps.UnitSystem.IMPERIAL,durationInTraffic:!1,avoidHighways:!1,avoidTolls:!1},c)}function handleDistanceMatrixResult(a,b){if(b!=google.maps.DistanceMatrixStatus.OK)alert("Error was: "+b);else for(var c=a.originAddresses,d=a.destinationAddresses,e=0;e<c.length;e++){var f=a.rows[e].elements,g=f.slice(0).sort(function(a,b){return a.distance.value<b.distance.value?-1:a.distance.value>b.distance.value?1:0}).slice(0,closestNumber),h=g.map(function(a){return[d[f.indexOf(a)],a]});getClosest(h,c[0])}}function showLayers(a){return a&&(!a||a!==stores)||storesReady?(a=a||stores,(!a instanceof Array||!a.length)&&(a=[a]),a.forEach(function(a){a.setMap(map)}),$(".showStores").removeClass("show"),a):alert("Oops, stores are still loading.  Google's geocoding api did not allow the results to load this fast")}function hideLayers(a){return a=a||stores,a.forEach(function(a){a.setMap(null)}),$(".showStores").addClass("show"),a}function addStoresByLatLng(){addresses.features.forEach(function(a){addMarker(new google.maps.LatLng(a.latlng[0],a.latlng[1]),["<h5>"+(a.name||"unknown")+"</h5>","<span>"+(a.address||a)+"</span>"].join(""),stores)})}function geocodeStores(a){if(a=a||0,!(a>addresses.features.length)){var b=addresses.features[a];b&&(showLoading("loading... store "+a+" of "+addresses.features.length),codeAddress(b,addMarker,a,stores))}}function codeAddress(a,b,c,d){geocoder.geocode({address:a.address||a},function(e,f){f==google.maps.GeocoderStatus.OK?(b(e[0].geometry.location,["<h5>"+(a.name||"unknown")+"</h5>","<span>"+(a.address||a)+"</span>"].join(""),d),c>=0&&setTimeout(function(){geocodeStores(c+1,d)},300)):(console.log("Geocode was not successful for the following reason: "+f),setTimeout(function(){codeAddress(a,b,c,d)},1e3))})}function getClosest(a,b){var c=[];return hideLayers(stores),a instanceof Array||"string"==typeof a?(a.forEach(function(a){var d=a[1];a=a[0],stores.forEach(function(e){var f=$(e.info),g=a.split(" ")[0].trim(),h=f[1].innerText.split(" ")[0].trim(),i=f[1].innerText.split(","),j=a.split(",");h===g&&j[j.length-2].trim()==i[i.length-1].trim()&&(c.push([e,d]),calcRoute(b,f[1].innerText,e))})}),$("ul.closest").empty(),void(closestStores=c.slice(0,closestNumber).forEach(function(a){var b=a[0],c=a[1];if(b){var d=$(b.info),a=$("<li></li>").on("click",function(){showInfoWindow(b,b.info),hideLayers(directionsLayers);var a;b.directions&&(showLayers([b,b.directions]),b.directions.setPanel($("#directions").empty()[0]),a=map.getCenter(),$(".cansplit:not(.split)").addClass("split"),map.getCenter(a),showDirectionsButton())}).html(d.append("<i>"+["",c.distance.text,c.duration.text].join("<br/>")+"</i>").html()).attr("title",d[1].innerText).appendTo("ul.closest");return b.setMap(map)}}))):getDrivingDistance(map.getCenter(),stores,handleDistanceMatrixResult)}function markMe(a){var b="https://chart.googleapis.com/chart?chst=d_map_spin&chld=0.5|0|FFFF42|10|b|ME";meMarker?meMarker.setPosition(a):meMarker=new google.maps.Marker({position:a,map:map,zIndex:999,visible:!0,icon:b})}function setCenter(a,b){var c=a.coords?new google.maps.LatLng(a.coords.latitude,a.coords.longitude):a;map.setCenter(c),markMe(c),"init"!==b&&getClosest(c)}function showInfoWindow(a,b){var c={map:map,position:a.position,content:b||a.info||"Right here."};map.infowindow?(map.infowindow.close(),map.infowindow.setOptions(c)):map.infowindow=new google.maps.InfoWindow(c)}function addMarker(a,b,c){var d=new google.maps.Marker({position:a,info:b});google.maps.event.addListener(d,"click",function(){showInfoWindow(d)}),c?(c.length<addresses.features.length&&c.push(d),c.length===addresses.features.length&&(storesReady=!0,hideLoading(),displayShowStoresButton())):console.log("no stores")}function displayShowStoresButton(){$(".showStores").removeClass("hidden").off("click").on("click",function(){$(this).hasClass("show")?showLayers(stores):hideLayers([].concat(directionsLayers,stores))})}function showDirectionsButton(){var a;$(".showDirections").removeClass("hidden").off("click").on("click",function(){$(this).hasClass("show")?showLayers(directionsLayers):(hideLayers([].concat(directionsLayers,closestStores||[])),$(this).addClass("hidden"),a=map.getCenter(),clearResults()),map.getCenter(a)})}function clearResults(){$("#directions").empty(),$(".split").removeClass("split")}function hideLoading(){$(".loading").fadeOut()}function showLoading(a){$(".loading").html(a||"loading...").fadeIn()}function locate(a){navigator.geolocation?navigator.geolocation.getCurrentPosition(function(b){setCenter(b,a)},function(){handleNoGeolocation(!0)}):handleNoGeolocation(!1)}function handleNoGeolocation(a){if(a)var b="Error: The Geolocation service failed.";else var b="Error: Your browser doesn't support geolocation.";var c={map:map,position:new google.maps.LatLng(60,105),content:b};map.setCenter(c.position)}function loadScript(){var a=document.createElement("script");a.type="text/javascript",a.src="https://maps.googleapis.com/maps/api/js?libraries=geometry,places&v=3.exp&sensor=true&callback=initialize",document.body.appendChild(a)}function onPlaceChanged(){map.infowindow&&map.infowindow.close();var a=autocomplete.getPlace();a.geometry&&(a.geometry.viewport?map.fitBounds(a.geometry.viewport):(map.setCenter(a.geometry.location),map.setZoom(14)),clearResults(),markMe(map.getCenter()),getDrivingDistance(map.getCenter(),stores,handleDistanceMatrixResult))}function calcRoute(a,b,c){var d={origin:a,destination:b,travelMode:google.maps.TravelMode.DRIVING},e={suppressMarkers:!0},f=new google.maps.DirectionsRenderer(e);f.setMap(map),c.setMap(map),c.setVisible(!0),c.directions=f,directionsLayers.push(f),directionsService.route(d,function(c,d){d==google.maps.DirectionsStatus.OK?f.setDirections(c):console.log("routing failed:",d,"for",a,"to",b)}),showDirectionsButton(),hideLoading()}var addresses={features:[{name:"Rincon Beach Park Paninis",address:"610 Mission Canyon Rd, Santa Barbara, CA 93105",latlng:[34.4408592,-119.71285929999999]},{name:"Pillar Point Patio",address:"West Point Avenue, Half Moon Bay, CA 94019",latlng:[37.503373,-122.49472230000003]},{name:"Santa Cruz Surfin Museum and Food Stop",address:"701 West Cliff Dr, Santa Cruz, CA 95060",latlng:[36.951449,-122.02667989999998]},{name:"Surfers Point Park Picnic Place",address:"Shoreline Dr, Ventura, CA 93001",latlng:[34.2745307,-119.3005384]},{name:"Malibu Lagoon State Beach BBQ",address:"23200 Pacific Coast Hwy, Malibu, CA 90265",latlng:[34.0344382,-118.67952179999997]},{name:"Long Beach Lodge Resort and Restaurant",address:"1441 Pacific Rim Highway, Tofino, BC V0R",latlng:[49.1066571,-125.86797919999998]},{name:"San Onofre State Beach Buffet",address:"Old Highway 101, San Clemente, CA 92672",latlng:[33.3812955,-117.57369030000001]},{name:"Elizabeth's Market",address:"23040 E Cliff Dr, Santa Cruz, CA 95062",latlng:[36.955626,-121.97243700000001]},{name:"AÃ±o Nuevo State Park Fast",address:"New Years Creek Rd, Pescadero, CA 94060",latlng:[37.1196843,-122.30679900000001]},{name:"Phil's Fish Market & Eatery",address:"7600 Sandholdt Rd, Moss Landing, CA 95039",latlng:[36.803346,-121.78773100000001]},{name:"Dolphin Restaurant",address:"71 Municipal Wharf, Santa Cruz, CA 95060",latlng:[36.957558,-122.01737400000002]},{name:"Davenport Roadhouse Restaurant and Inn",address:"1 Davenport Ave, Davenport, CA 95017",latlng:[37.0108619,-122.19388200000003]},{name:"Swanton Berry Farm",address:"25 Swanton Rd, Davenport, CA 95017",latlng:[37.0303339,-122.21847530000002]},{name:"Point Reyes Lighthouse Visitor Information Center and Chophouse",address:"27000 Sir Francis Drake Blvd, Inverness, CA 94937",latlng:[37.9965067,-123.02050759999997]},{name:"Pier Chowder House & Tap Room",address:"790 Port Rd, Point Arena, CA 95468",latlng:[38.9146233,-123.70941879999998]},{name:"Griffin House Inn",address:"5910 California 1, Elk, CA 95432",latlng:[39.1338873,-123.71847680000002]},{name:"Chart Room Restaurant",address:"130 Anchor Way, Crescent City, CA 95531",latlng:[41.7438102,-124.1810585]},{name:"Spinner's Seafood Steak & Chop House",address:"29430 Ellensburg Ave, Gold Beach, OR 97444",latlng:[42.4064127,-124.4219104]},{name:"The Crazy Norwegians Fish and Chips",address:"259 6th St, Port Orford, OR 97465",latlng:[42.7435023,-124.49451479999999]},{name:"Griff's On the Dock",address:"Dock Road, Port Orford, OR 97465",latlng:[42.7417009,-124.49864760000003]},{name:"Salty Dawg Saloon",address:"4380 Homer Spit Rd, Homer, AK 99603",latlng:[59.6063736,-151.43386269999996]}]},map,geocoder,autocomplete,distanceMatrix,directionsDisplay,directionsService,storesReady,directionsLayers=[],stores=[],closestStores,closestNumber=5,meMarker;$(".locate").on("click",locate),window.onload=loadScript;